---
import type { BlueskyPost } from "../lib/bluesky";
import { Icon } from "astro-icon/components";

export interface Props {
  post: BlueskyPost;
}

const { post } = Astro.props;

// Format relative time
function formatRelativeTime(date: Date): string {
  const now = new Date();
  const diffMs = now.getTime() - date.getTime();
  const diffSecs = Math.floor(diffMs / 1000);
  const diffMins = Math.floor(diffSecs / 60);
  const diffHours = Math.floor(diffMins / 60);
  const diffDays = Math.floor(diffHours / 24);

  if (diffDays > 7) {
    return date.toLocaleDateString("en-US", {
      month: "short",
      day: "numeric",
      year: date.getFullYear() !== now.getFullYear() ? "numeric" : undefined,
    });
  } else if (diffDays > 0) {
    return `${diffDays}d ago`;
  } else if (diffHours > 0) {
    return `${diffHours}h ago`;
  } else if (diffMins > 0) {
    return `${diffMins}m ago`;
  } else {
    return "just now";
  }
}

const relativeTime = formatRelativeTime(post.createdAt);
---

<section class="p-4 md:w-1/2 lg:w-1/3">
  <div
    class="h-full border-1 border-gray-200 bg-white dark:border-gray-700 dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden p-4 flex flex-col"
  >
    <!-- Author Header -->
    <div class="flex items-center mb-3">
      {
        post.authorAvatar ? (
          <img
            src={post.authorAvatar}
            alt={post.authorDisplayName}
            class="w-12 h-12 rounded-full object-cover mr-3 border-2 border-purple-200 dark:border-purple-700"
          />
        ) : (
          <div class="w-12 h-12 rounded-full bg-purple-200 dark:bg-purple-700 mr-3 flex items-center justify-center">
            <Icon
              name="mdi:account"
              class="w-8 h-8 text-purple-600 dark:text-purple-300"
            />
          </div>
        )
      }
      <div class="flex-1 min-w-0">
        <p
          class="font-semibold text-gray-900 dark:text-gray-100 truncate text-sm"
        >
          {post.authorDisplayName}
        </p>
        <p class="text-gray-500 dark:text-gray-400 text-xs truncate">
          @{post.authorHandle}
        </p>
      </div>
      <span class="text-gray-500 dark:text-gray-400 text-xs whitespace-nowrap">
        {relativeTime}
      </span>
    </div>

    <!-- Post Content -->
    <div class="flex-1 mb-4">
      <p
        class="text-gray-700 dark:text-gray-300 text-sm whitespace-pre-wrap break-words"
      >
        {post.text}
      </p>
    </div>

    <!-- Image Embeds -->
    {
      post.images && post.images.length > 0 && (
        <div
          class={`mb-4 grid gap-2 ${post.images.length === 1 ? "grid-cols-1" : "grid-cols-2"}`}
        >
          {post.images.map((image) => (
            <a
              href={image.fullsize}
              target="_blank"
              rel="noopener noreferrer"
              class="block overflow-hidden rounded-lg"
            >
              <img
                src={image.thumb}
                alt={image.alt || "Post image"}
                class="w-full h-32 object-cover hover:opacity-90 transition-opacity"
              />
            </a>
          ))}
        </div>
      )
    }

    <!-- External Link Embed -->
    {
      post.externalLink && (
        <a
          href={post.externalLink.uri}
          target="_blank"
          rel="noopener noreferrer"
          class="block mb-4 border border-gray-200 dark:border-gray-600 rounded-lg overflow-hidden hover:border-purple-400 dark:hover:border-purple-500 transition-colors"
        >
          {post.externalLink.thumb && (
            <img
              src={post.externalLink.thumb}
              alt={post.externalLink.title}
              class="w-full h-32 object-cover"
            />
          )}
          <div class="p-3">
            <p class="font-medium text-gray-900 dark:text-gray-100 text-sm truncate">
              {post.externalLink.title}
            </p>
            <p class="text-gray-500 dark:text-gray-400 text-xs line-clamp-2 mt-1">
              {post.externalLink.description}
            </p>
          </div>
        </a>
      )
    }

    <!-- Engagement Metrics -->
    <div
      class="flex items-center justify-between text-gray-500 dark:text-gray-400 text-xs border-t border-gray-100 dark:border-gray-700 pt-3 mt-auto"
    >
      <div class="flex items-center space-x-4">
        <span class="inline-flex items-center">
          <Icon name="mdi:chat-outline" class="w-4 h-4 mr-1" />
          {post.replyCount}
        </span>
        <span class="inline-flex items-center">
          <Icon name="mdi:repeat" class="w-4 h-4 mr-1" />
          {post.repostCount}
        </span>
        <span class="inline-flex items-center">
          <Icon name="mdi:heart-outline" class="w-4 h-4 mr-1" />
          {post.likeCount}
        </span>
      </div>
      <a
        href={post.url}
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center text-purple-600 hover:text-pink-600 dark:text-purple-300 dark:hover:text-pink-300 font-medium transition-colors"
      >
        <span>View on Bluesky</span>
        <Icon name="mdi:open-in-new" class="w-3 h-3 ml-1" />
      </a>
    </div>
  </div>
</section>
