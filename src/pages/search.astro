---
import type { Frontmatter } from "../config";
import { SiteMetadata } from "../config";
import Base from "../layouts/base.astro";
import PageHero from "../components/pagehero.astro";

const frontmatter: Frontmatter = {
  title: "Search Blog",
  description: "Search through blog posts",
  coverSVG: "../images/svg/undraw/santosh_yadav.svg",
  socialImage: "../images/undraw/santosh_yadav.jpg",
  publishDate: SiteMetadata.buildTime,
};
---

<Base frontmatter={frontmatter}>
  <header>
    <PageHero
      title={frontmatter.title}
      description={frontmatter.description}
      coverSVG={frontmatter.coverSVG}
      socialImage={frontmatter.socialImage}
    />
  </header>
  <main class="mt-10 bg-gray-100 dark:bg-gray-900 min-h-screen">
    <div class="container mx-auto px-4 py-8">
      <!-- Search Input -->
      <div class="mb-8">
        <input
          type="text"
          id="search-input"
          placeholder="Search blog posts..."
          class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
      </div>

      <!-- Search Results -->
      <div id="search-results" class="space-y-4">
        <p class="text-gray-600 dark:text-gray-400">
          Start typing to search blog posts...
        </p>
      </div>

      <!-- Loading State -->
      <div id="search-loading" class="hidden text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
        <p class="mt-2 text-gray-600 dark:text-gray-400">Loading search index...</p>
      </div>
    </div>
  </main>

  <script>
    import lunr from "lunr";

    let searchIndex: lunr.Index;
    let searchData: any[] = [];
    let isIndexReady = false;
    let isIndexLoading = false;

    // Load search index (lazy - only called when needed)
    async function loadSearchIndex(): Promise<boolean> {
      // Prevent duplicate API calls
      if (isIndexReady) return true;
      if (isIndexLoading) return false;
      
      isIndexLoading = true;
      const loadingEl = document.getElementById("search-loading");
      const resultsEl = document.getElementById("search-results");
      
      if (loadingEl && resultsEl) {
        loadingEl.classList.remove("hidden");
        resultsEl.innerHTML = "";
      }

      try {
        const response = await fetch("/api/search.json");
        searchData = await response.json();

        // Build Lunr index
        searchIndex = lunr(function () {
          this.ref("slug");
          this.field("title", { boost: 10 });
          this.field("description", { boost: 5 });
          this.field("content");
          this.field("tags", { boost: 3 });
          this.field("categories", { boost: 3 });
          this.field("author");

          searchData.forEach((doc) => {
            this.add(doc);
          });
        });

        isIndexReady = true;
        isIndexLoading = false;
        
        if (loadingEl) {
          loadingEl.classList.add("hidden");
        }
        
        return true;
      } catch (error) {
        console.error("Failed to load search index:", error);
        isIndexLoading = false;
        if (resultsEl) {
          resultsEl.innerHTML = '<p class="text-red-600 dark:text-red-400">Failed to load search index. Please try again later.</p>';
        }
        if (loadingEl) {
          loadingEl.classList.add("hidden");
        }
        return false;
      }
    }

    // Perform search (assumes index is ready)
    function performSearch(query: string) {
      const resultsEl = document.getElementById("search-results");
      if (!resultsEl) return;

      if (!query.trim()) {
        resultsEl.innerHTML = '<p class="text-gray-600 dark:text-gray-400">Start typing to search blog posts...</p>';
        return;
      }

      if (!isIndexReady) {
        resultsEl.innerHTML = '<p class="text-gray-600 dark:text-gray-400">Search index is loading...</p>';
        return;
      }

      try {
        const results = searchIndex.search(query);

        if (results.length === 0) {
          resultsEl.innerHTML = `<p class="text-gray-600 dark:text-gray-400">No results found for "${query}"</p>`;
          return;
        }

        const resultsHTML = results
          .map((result) => {
            const post = searchData.find((p) => p.slug === result.ref);
            if (!post) return "";

            return `
              <article class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow">
                <a href="/blog/${post.slug}" class="group">
                  <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 group-hover:text-blue-600 dark:group-hover:text-blue-400 mb-2">
                    ${post.title}
                  </h3>
                  <p class="text-gray-600 dark:text-gray-400 mb-3">
                    ${post.description}
                  </p>
                  <div class="flex items-center text-sm text-gray-500 dark:text-gray-500">
                    <span>${new Date(post.publishDate).toLocaleDateString()}</span>
                    ${post.author ? `<span class="mx-2">•</span><span>${post.author}</span>` : ""}
                    ${post.tags?.length > 0 ? `<span class="mx-2">•</span><span class="text-blue-600 dark:text-blue-400">${post.tags.slice(0, 3).join(", ")}</span>` : ""}
                  </div>
                </a>
              </article>
            `;
          })
          .join("");

        resultsEl.innerHTML = `
          <p class="text-gray-600 dark:text-gray-400 mb-4">Found ${results.length} result${results.length !== 1 ? "s" : ""}</p>
          ${resultsHTML}
        `;
      } catch (error) {
        console.error("Search error:", error);
        resultsEl.innerHTML = '<p class="text-red-600 dark:text-red-400">An error occurred while searching. Please try again.</p>';
      }
    }

    // Debounced search - loads index lazily and performs search
    function debounce<T extends (...args: any[]) => any>(fn: T, delay: number): (...args: Parameters<T>) => void {
      let timer: ReturnType<typeof setTimeout>;
      return (...args: Parameters<T>) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn(...args), delay);
      };
    }

    async function handleSearch(query: string) {
      if (!query.trim()) {
        const resultsEl = document.getElementById("search-results");
        if (resultsEl) {
          resultsEl.innerHTML = '<p class="text-gray-600 dark:text-gray-400">Start typing to search blog posts...</p>';
        }
        return;
      }

      // Load index lazily on first search
      if (!isIndexReady) {
        const loaded = await loadSearchIndex();
        if (!loaded) return;
      }

      performSearch(query);
    }

    const debouncedSearch = debounce(handleSearch, 300);

    // Initialize search
    document.addEventListener("DOMContentLoaded", () => {
      const searchInput = document.getElementById("search-input") as HTMLInputElement;
      
      // Check if there's a query parameter
      const urlParams = new URLSearchParams(window.location.search);
      const query = urlParams.get("q");
      
      if (searchInput && query) {
        searchInput.value = query;
        // Trigger search for URL query (debounced)
        debouncedSearch(query);
      }

      if (searchInput) {
        searchInput.addEventListener("input", (e) => {
          debouncedSearch((e.target as HTMLInputElement).value);
        });
      }
    });
  </script>
</Base>
